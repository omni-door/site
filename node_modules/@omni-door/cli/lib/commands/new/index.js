"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __generator = (this && this.__generator) || function (thisArg, body) {
    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;
    return g = { next: verb(0), "throw": verb(1), "return": verb(2) }, typeof Symbol === "function" && (g[Symbol.iterator] = function() { return this; }), g;
    function verb(n) { return function (v) { return step([n, v]); }; }
    function step(op) {
        if (f) throw new TypeError("Generator is already executing.");
        while (_) try {
            if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
            if (y = 0, t) op = [op[0] & 2, t.value];
            switch (op[0]) {
                case 0: case 1: t = op; break;
                case 4: _.label++; return { value: op[1], done: false };
                case 5: _.label++; y = op[1]; op = [0]; continue;
                case 7: op = _.ops.pop(); _.trys.pop(); continue;
                default:
                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }
                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }
                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }
                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }
                    if (t[2]) _.ops.pop();
                    _.trys.pop(); continue;
            }
            op = body.call(thisArg, _);
        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }
        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };
    }
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var fs_1 = __importDefault(require("fs"));
var path_1 = __importDefault(require("path"));
var inquirer_1 = __importDefault(require("inquirer"));
var utils_1 = require("@omni-door/utils");
var utils_2 = require("../../utils");
function handleException(msg) {
    utils_1.logWarn(msg || 'å‘ç”Ÿäº†ä¸€äº›æœªçŸ¥é”™è¯¯ï¼(Ops! Some unknown errors have occurred!)');
    process.exit(0);
}
function default_1(config, componentName, options) {
    return __awaiter(this, void 0, void 0, function () {
        var e_1, _a, type, template, build, release, plugins, _b, root, test, _c, typescript, _d, stylesheet, _e, readme, module_cn, module_en, _f, fc, cc, tplPkj, tplPkjTag, before, after, moduleType_1, questions_1, mdx, path_cp, path_cp_rel, hasStorybook, params, newTplPkj, _g, newTpl;
        return __generator(this, function (_h) {
            switch (_h.label) {
                case 0:
                    _h.trys.push([0, 2, , 3]);
                    // node version pre-check
                    return [4 /*yield*/, utils_1.nodeVersionCheck('8')];
                case 1:
                    // node version pre-check
                    _h.sent();
                    return [3 /*break*/, 3];
                case 2:
                    e_1 = _h.sent();
                    utils_1.logWarn(e_1);
                    return [3 /*break*/, 3];
                case 3:
                    if (!config || JSON.stringify(config) === '{}') {
                        handleException('è¯·å…ˆåˆå§‹åŒ–é¡¹ç›®ï¼(Please initialize first!)');
                    }
                    _a = config, type = _a.type, template = _a.template, build = _a.build, release = _a.release, plugins = _a.plugins;
                    if (!type) {
                        handleException('é¡¹ç›®ç±»å‹ç¼ºå¤±ï¼(Cannot find the project type!)');
                    }
                    _b = template, root = _b.root, test = _b.test, _c = _b.typescript, typescript = _c === void 0 ? false : _c, _d = _b.stylesheet, stylesheet = _d === void 0 ? '' : _d, _e = _b.readme, readme = _e === void 0 ? [false, 'md'] : _e;
                    module_cn = 'ç»„ä»¶';
                    module_en = 'component';
                    if (type === 'toolkit') {
                        module_cn = 'æ¨¡å—';
                        module_en = 'module';
                    }
                    _f = options || {}, fc = _f.function, cc = _f.class, tplPkj = _f.tplPkj, tplPkjTag = _f.tplPkjTag, before = _f.before, after = _f.after;
                    if (!root) {
                        handleException("\u751F\u6210" + module_cn + "\u7684\u8DEF\u5F84\u7F3A\u5931\uFF01(Missing the path for generate template!)");
                    }
                    if (!(!componentName || (!fc && !cc))) return [3 /*break*/, 5];
                    moduleType_1 = {
                        fc: "\u51FD\u6570" + module_cn + " (functional-" + module_en + ")",
                        cc: "\u7C7B" + module_cn + " (class-" + module_en + ")"
                    };
                    questions_1 = [
                        {
                            name: 'name',
                            type: 'input',
                            when: function (answer) {
                                if (componentName) {
                                    return false;
                                }
                                return true;
                            },
                            message: utils_2.logo() + "\u8BF7\u8F93\u5165" + module_cn + "\u540D\u79F0 (Please enter " + module_en + " name)\uFF1A"
                        },
                        {
                            name: 'type',
                            type: 'list',
                            when: function (answer) {
                                if (!answer.name && !componentName) {
                                    handleException("\u8BF7\u8F93\u5165\u521B\u5EFA\u7684" + module_cn + "\u540D\u79F0\uFF01(Please input the " + module_en + " name!)");
                                }
                                if (type === 'spa-vue' || type === 'toolkit' || fc || cc) {
                                    return false;
                                }
                                return true;
                            },
                            choices: [moduleType_1.fc, moduleType_1.cc],
                            message: utils_2.logo() + "\u9009\u62E9" + module_cn + "\u7C7B\u578B (Please choose the type of " + module_en + ")"
                        }
                    ];
                    return [4 /*yield*/, new Promise(function (resolve) {
                            inquirer_1.default.prompt(questions_1)
                                .then(function (answers) {
                                var name = answers.name, type = answers.type;
                                componentName = name || componentName;
                                if (type === moduleType_1.fc) {
                                    fc = true;
                                }
                                else if (type === moduleType_1.cc) {
                                    cc = true;
                                }
                                resolve(void 0);
                            });
                        }).catch(function (err) {
                            handleException(err);
                        })];
                case 4:
                    _h.sent();
                    _h.label = 5;
                case 5:
                    if (!/^[a-zA-Z\_]\w+$/g.test(componentName)) {
                        handleException("\u8BF7\u8F93\u5165\u5408\u6CD5\u7684" + module_cn + "\u540D\u79F0\uFF01(Please input a valid module name!)\n\n      \u89C4\u5219\uFF1A\n\n        1. " + module_cn + "\u540D\u5927\u4E8E\u7B49\u4E8E2\u4E2A\u5B57\u7B26\uFF1B(module name must greater-or-equal 2)\n\n        2. \u7B2C\u4E00\u4E2A\u5B57\u7B26\u53EA\u80FD\u7531 \u4E0B\u5212\u7EBF_ \u6216 \u5927\u5C0F\u5199\u5B57\u6BCD \u7EC4\u6210\uFF1B(the first character can only be underscore or upper/lower case letter)\n\n        3. \u540E\u7EED\u5B57\u7B26\u53EA\u80FD\u7531 \u6570\u5B57\u3001\u4E0B\u5212\u7EBF_\u3001\u5927\u5C0F\u5199\u5B57\u6BCD \u7EC4\u6210\uFF01(subsequent characters can only be numberm, underscore, upper and lower case letter)\n\n      ");
                    }
                    // bind exit signals
                    utils_2.signal();
                    mdx = readme[1] === 'mdx';
                    path_cp = path_1.default.resolve(root, componentName);
                    path_cp_rel = path_1.default.relative(process.cwd(), path_cp);
                    if (fs_1.default.existsSync(path_cp)) {
                        handleException(module_cn + " " + componentName + " \u5DF2\u5B58\u5728\uFF01(The " + componentName + " module had been existed!)");
                    }
                    hasStorybook = fs_1.default.existsSync(path_1.default.resolve(process.cwd(), '.storybook'));
                    params = [
                        "componentName=" + componentName,
                        "newPath=" + path_cp,
                        "stylesheet=" + stylesheet,
                        "ts=" + typescript,
                        "type=" + (cc ? 'cc' : 'fc'),
                        "test=" + !!test,
                        "hasStorybook=" + hasStorybook,
                        readme[0] ? "md=" + (mdx ? 'mdx' : 'md') : ''
                    ];
                    newTplPkj = tplPkj;
                    if (!newTplPkj) {
                        switch (type) {
                            case 'spa-react':
                                newTplPkj = '@omni-door/tpl-spa-react';
                                break;
                            case 'spa-vue':
                                newTplPkj = '@omni-door/tpl-spa-vue';
                                break;
                            case 'ssr-react':
                                newTplPkj = '@omni-door/tpl-ssr-react';
                                break;
                            case 'component-react':
                                newTplPkj = '@omni-door/tpl-component-react';
                                break;
                            case 'toolkit':
                            default:
                                newTplPkj = '@omni-door/tpl-toolkit';
                                break;
                        }
                    }
                    _g = typeof before === 'function';
                    if (!_g) return [3 /*break*/, 7];
                    return [4 /*yield*/, before({
                            componentName: componentName,
                            root: root
                        })];
                case 6:
                    _g = (_h.sent());
                    _h.label = 7;
                case 7:
                    _g;
                    newTpl = newTplPkj + "@" + (tplPkjTag || 'latest');
                    utils_1.logInfo("\u6B63\u5728\u4E0B\u8F7D " + newTpl + " \u6A21\u677F\uFF0C\u8BF7\u7A0D\u540E... (Downloading the templates, please wait patiently\u2026)");
                    utils_1.exec([
                        "npx " + newTpl + " new " + utils_1.arr2str(params)
                    ], function () {
                        return __awaiter(this, void 0, void 0, function () {
                            var plugin_handles, _a, _b, _i, name_1, handler, _c;
                            return __generator(this, function (_d) {
                                switch (_d.label) {
                                    case 0:
                                        plugin_handles = plugins && plugins.length > 0 && utils_2.getHandlers(plugins, 'new');
                                        if (!plugin_handles) return [3 /*break*/, 4];
                                        _a = [];
                                        for (_b in plugin_handles)
                                            _a.push(_b);
                                        _i = 0;
                                        _d.label = 1;
                                    case 1:
                                        if (!(_i < _a.length)) return [3 /*break*/, 4];
                                        name_1 = _a[_i];
                                        handler = plugin_handles[name_1];
                                        return [4 /*yield*/, handler({
                                                type: type,
                                                template: template,
                                                build: build,
                                                release: release
                                            }, {
                                                componentName: componentName,
                                                componentType: cc ? 'class' : 'function',
                                                tplSource: newTplPkj
                                            })];
                                    case 2:
                                        _d.sent();
                                        _d.label = 3;
                                    case 3:
                                        _i++;
                                        return [3 /*break*/, 1];
                                    case 4:
                                        _c = typeof after === 'function';
                                        if (!_c) return [3 /*break*/, 6];
                                        return [4 /*yield*/, after({
                                                componentName: componentName,
                                                root: root
                                            })];
                                    case 5:
                                        _c = (_d.sent());
                                        _d.label = 6;
                                    case 6:
                                        _c;
                                        // success logger
                                        utils_1.logSuc(componentName + " \u4F4D\u4E8E " + path_cp_rel + "\uFF0C\u521B\u5EFA\u5B8C\u6210\uFF01(The " + componentName + " local at " + path_cp_rel + ", construction completed!)");
                                        process.exit(0);
                                        return [2 /*return*/];
                                }
                            });
                        });
                    }, function (err) {
                        utils_1.logErr(err);
                        utils_1.logErr('ğŸ‘† å®Œè›‹ï¼å¥½åƒæœ‰é”™è¯¯ï¼(Oops! Some error occured)\n');
                        process.exit(1);
                    });
                    return [2 /*return*/];
            }
        });
    });
}
exports.default = default_1;
